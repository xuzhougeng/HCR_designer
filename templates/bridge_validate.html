{% extends "base.html" %}

{% block title %}Bridge Probe 验证系统{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Bridge Probe 序列验证</h1>
    
    <div class="action-buttons">
        <a href="{{ url_for('bridge') }}" class="btn btn-outline-primary">
            切换到设计系统
        </a>
        <a href="{{ url_for('bridge_query') }}" class="btn btn-outline-primary ms-2">
            切换到查询系统
        </a>
        <a href="{{ url_for('bridge_list') }}" class="btn btn-outline-primary ms-2">
            查看探针列表
        </a>
    </div>

    <form method="POST" enctype="multipart/form-data" class="validate-form">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="probe_file" class="form-label">上传探针CSV文件</label>
                    <input type="file" class="form-control" id="probe_file" name="probe_file" 
                           accept=".csv" required>
                    <div class="form-text">请上传包含探针ID和序列的CSV文件（第一列为ID，第二列为序列）</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h4>序列长度</h4>
                <div class="mb-3">
                    <label for="min_length" class="form-label">最小长度</label>
                    <input type="number" class="form-control" id="min_length" name="min_length" 
                           value="{{ min_length }}" min="10" max="50">
                </div>
                <div class="mb-3">
                    <label for="max_length" class="form-label">最大长度</label>
                    <input type="number" class="form-control" id="max_length" name="max_length" 
                           value="{{ max_length }}" min="10" max="50">
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>GC含量 (%)</h4>
                <div class="mb-3">
                    <label for="min_gc" class="form-label">最小GC含量</label>
                    <input type="number" class="form-control" id="min_gc" name="min_gc" 
                           value="{{ min_gc }}" min="0" max="100" step="0.1">
                </div>
                <div class="mb-3">
                    <label for="max_gc" class="form-label">最大GC含量</label>
                    <input type="number" class="form-control" id="max_gc" name="max_gc" 
                           value="{{ max_gc }}" min="0" max="100" step="0.1">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h4>Tm值 (°C)</h4>
                <div class="mb-3">
                    <label for="min_tm" class="form-label">最小Tm值</label>
                    <input type="number" class="form-control" id="min_tm" name="min_tm" 
                           value="{{ min_tm }}" min="0" max="100" step="0.1">
                </div>
                <div class="mb-3">
                    <label for="max_tm" class="form-label">最大Tm值</label>
                    <input type="number" class="form-control" id="max_tm" name="max_tm" 
                           value="{{ max_tm }}" min="0" max="100" step="0.1">
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>其他参数</h4>
                <div class="mb-3">
                    <label for="poly_n" class="form-label">最大连续碱基数</label>
                    <input type="number" class="form-control" id="poly_n" name="poly_n" 
                           value="{{ poly_n }}" min="2" max="10">
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">验证序列</button>
    </form>

    {% if error %}
    <div class="alert alert-danger mt-4" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if results %}
    <div class="results mt-4">
        <h3>验证结果</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>探针ID</th>
                        <th>序列</th>
                        <th>状态</th>
                        <th>原因</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>{{ result.probe_id }}</td>
                        <td class="sequence-cell">{{ result.sequence }}</td>
                        <td>
                            {% if result.is_valid %}
                            <span class="badge bg-success">合格</span>
                            {% else %}
                            <span class="badge bg-danger">不合格</span>
                            {% endif %}
                        </td>
                        <td>{{ result.reasons }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="action-buttons mt-3">
            <button class="btn btn-success" onclick="downloadResults()">下载验证结果</button>
        </div>
    </div>

    <script>
    function downloadResults() {
        const rows = document.querySelectorAll('table tbody tr');
        let csv = 'Probe_ID,Sequence,Status,Reasons\n';
        
        rows.forEach(row => {
            const probe_id = row.cells[0].textContent.trim();
            const sequence = row.cells[1].textContent.trim();
            const status = row.cells[2].querySelector('.badge').textContent.trim();
            const reasons = row.cells[3].textContent.trim();
            csv += `${probe_id},${sequence},${status},${reasons}\n`;
        });
        
        downloadFile(csv, 'probe_validation_results.csv');
    }
    
    function downloadFile(content, filename) {
        const blob = new Blob([content], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    </script>
    {% endif %}
</div>
{% endblock %} 